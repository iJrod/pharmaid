<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTI Decision Tree Questionnaire</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f4;
            color: #333;
            line-height: 1.6;
        }
        .hidden {
            display: none !important;
        }
        .container {
            width: 80%;
            max-width: 800px;
            margin: auto;
            padding: 20px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .input-wrapper {
            /* Flexbox for right alignment */
            display: flex;
            justify-content: flex-end;
            flex-grow: 1;
        }
        .question {
            margin-top: 20px;
            padding: 10px;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .question:last-child {
            border-bottom: none;
        }
        .question label {
            display: inline-block;
            margin-right: 10px;
            font-size: 18px;
            vertical-align: middle;
        }

        .question input[type="checkbox"], .question input[type="radio"] {
            width: 20px;
            height: 20px;
            vertical-align: middle;
        }

        /* Custom Checkbox Styling */
        .question input[type="checkbox"], .question input[type="radio"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: #f0f0f0;
            border: 2px solid #cacece;
            padding: 10px;
            border-radius: 3px;
            display: inline-block;
            position: relative;
        }

        .question input[type="checkbox"]:checked, .question input[type="radio"]:checked {
            background-color: #007bff;
            border: 2px solid #007bff;
        }

        .question input[type="checkbox"]:checked:after, .question input[type="radio"]:checked:after {
            content: '';
            position: absolute;
            left: 4px;
            top: 4px;
            width: 12px;
            height: 12px;
            border-radius: 3px;
            background: white;
        }

        /* For Radio Buttons to have a circular shape */
        .question input[type="radio"] {
            border-radius: 50%;
        }

        .question input[type="radio"]:checked:after {
            border-radius: 50%;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-size: 18px;
        }
        input[type="checkbox"], input[type="radio"] {
            margin-right: 10px;
        }
        button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-top: 20px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
        }
        button:hover {
            background: #0056b3;
        }
        #summary {
            margin-top: 20px;
            padding: 10px;
            background: #e7f3ff;
            border: 1px solid #bce8f1;
        }
        #summary ul {
            padding-left: 20px;
        }
        #summary li {
            margin-bottom: 10px;
        }
    </style>

</head>
<body>
    <div class="container">
        <h1>UTI Decision Tree Questionnaire</h1>

        <form id="utiForm">
            <!-- Group 1: Initial Questions -->
            <div id="group_initial_questions">
                <div class="question">
                    <label for="pregnant">Pregnant:</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="pregnant" name="pregnant">
                    </div>
                </div>
                <div class="question">
                    <label for="urinary_catheter">Urinary Catheter:</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="urinary_catheter" name="urinary_catheter">
                    </div>
                </div>
                <div class="question">
                    <label for="recurrent_uti">Recurrent UTI:</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="recurrent_uti" name="recurrent_uti">
                    </div>
                </div>
            </div>

            <!-- Group 2: PYELONEPHRITIS Symptoms -->
            <div id="group_pyelonephritis_symptoms" class="hidden">

                <div class="question">
                    <label for="kidney_pain">Kidney pain/tenderness in back under ribs:</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="kidney_pain" name="kidney_pain">
                    </div>
                </div>

                <div class="question" id="question_flu_like_symptoms">
                    <label for="flu_like_symptoms">New/different myalgia, flu like illness:</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="flu_like_symptoms" name="flu_like_symptoms">
                    </div>
                </div>

                <div class="question" id="question_high_temperature">
                    <label for="high_temperature">Shaking chills (riggers) or temperature 37.9C or above:</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="high_temperature" name="high_temperature">
                    </div>
                </div>

                <div class="question" id="question_nausea_vomiting">
                    <label for="nausea_vomiting">Nausea/vomiting:</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="nausea_vomiting" name="nausea_vomiting">
                    </div>
                </div>

            </div>

            <!-- Group 3: Additional Checks -->
            <div id="group_additional_checks" class="hidden">

                <div class="question" id="question_vaginal_discharge">
                    <label for="vaginal_discharge">Vaginal discharge:</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="vaginal_discharge" name="vaginal_discharge">
                    </div>
                </div>

                <div class="question" id="question_urethritis">
                    <label for="urethritis">Urethritis:</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="urethritis" name="urethritis">
                    </div>
                </div>

                <div class="question" id="question_sexual_history">
                    <label for="sexual_history">Check sexual history to exclude sexually transmitted infections:</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="sexual_history" name="sexual_history">
                    </div>
                </div>

                <div class="question" id="question_signs_of_pregnancy">
                    <label for="signs_of_pregnancy">Check for signs and symptoms of pregnancy:</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="signs_of_pregnancy" name="signs_of_pregnancy">
                    </div>
                </div>

                <div class="question" id="question_genitourinary_syndrome">
                    <label for="genitourinary_syndrome">Genitourinary syndrome of menopause (vulvovaginal atrophy):</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="genitourinary_syndrome" name="genitourinary_syndrome">
                    </div>
                </div>

                <div class="question" id="question_immunosuppressed">
                    <label for="immunosuppressed">Is the patient immunosuppressed?</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="immunosuppressed" name="immunosuppressed">
                    </div>
                </div>
            </div>

            <!-- Group 4: Key Diagnostic Signs/Symptoms -->
            <div id="group_key_diagnostic_signs" class="hidden">
                <div class="question">
                    <label for="dysuria">Dysuria (burning pain when passing urine):</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="dysuria" name="dysuria">
                    </div>
                </div>
                <div class="question">
                    <label for="nocturia">New nocturia (needing to pass urine in the night):</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="nocturia" name="nocturia">
                    </div>
                </div>
                <div class="question">
                    <label for="cloudy_urine">Urine cloudy to the naked eye:</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="cloudy_urine" name="cloudy_urine">
                    </div>
                </div>
            </div>

            <!-- Group 5: Other Urinary Symptoms -->
            <div id="group_other_urinary_symptoms" class="hidden">
                <div class="question">
                    <label for="urgency">Urgency:</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="urgency" name="urgency">
                    </div>
                </div>
                <div class="question">
                    <label for="frequency">Frequency:</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="frequency" name="frequency">
                    </div>
                </div>
                <div class="question">
                    <label for="visible_haematuria">Visible haematuria:</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="visible_haematuria" name="visible_haematuria">
                    </div>
                </div>
                <div class="question">
                    <label for="suprapubic_pain">Suprapubic pain/tenderness:</label>
                    <div class="input-wrapper">
                        <input type="checkbox" id="suprapubic_pain" name="suprapubic_pain">
                    </div>
                </div>
            </div>

            <!-- Group 6: Shared Decision Making Approach -->
            <div id="group_shared_decision_making" class="hidden">
                <div class="question">
                    <label for="mild_symptoms">In patients that describe their symptoms as mild consider pain relief and self care as first line treatment:</label>
                    <div class="input-wrapper">
                        <input type="radio" id="mild_symptoms" name="decision_making" value="mild">
                    </div>
                </div>
                <div class="question">
                    <label for="moderate_severe_symptoms">In patients with moderate to severe symptoms:</label>
                    <div class="input-wrapper">
                        <input type="radio" id="moderate_severe_symptoms" name="decision_making" value="moderate_severe">
                    </div>
                </div>
            </div>

            <!-- Applicable for All Patients -->
            <div id="group_applicable_for_all" class="hidden question-group">
                <h2>SUMMARY:</h2>
                <div id="summary"></div>  <!-- Element to display the summary -->
                <br/>
                <h2>FOR ALL PATIENTS:</h2>
                <p>
                    If symptoms worsen rapidly or significantly at any time, OR do not improve in 48 hours of taking antibiotics:
                    <p>
                        Onward referral:
                            <li>General Practice</li>
                            <li>Other provider as appropriate</li>
                    </p>
                </p>
                <p>
                    Share self-care and safety-netting advice using TARGET UTI leaflet
                </p>
                <button id="restartButton" type="button">Restart</button>
            </div>
        </form>

        <div id="result"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let summaryInfo = []; // Array to store summary information

            function checkExclusion() {
                const isPregnant = document.getElementById('pregnant').checked;
                const hasCatheter = document.getElementById('urinary_catheter').checked;
                const hasRecurrentUTI = document.getElementById('recurrent_uti').checked;
                return isPregnant || hasCatheter || hasRecurrentUTI;
            }

            function checkAnyChecked(checkboxes) {
                return Array.from(checkboxes).some(cb => cb.checked);
            }

            function toggleQuestionGroup(currentGroupId, nextGroupId) {
                const currentGroup = document.getElementById(currentGroupId);
                const nextGroup = document.getElementById(nextGroupId);

                if (currentGroup) {
                    currentGroup.classList.add('hidden');
                }
                if (nextGroup) {
                    nextGroup.classList.remove('hidden');
                }
            }

            function updateSummary(text) {
                // Replace newline characters (\n) with <br> tags
                text = text.replace(/\n/g, '<br/>');
                summaryInfo.push(text);
            }

            function displaySummary() {
                const summaryElement = document.getElementById('summary');
                if (summaryElement) {
                    // Clear previous summary content
                    summaryElement.innerHTML = '';

                    // Create an unordered list element
                    const ul = document.createElement('ul');

                    // Loop through summaryInfo and create list items with HTML content
                    summaryInfo.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = item; // Use innerHTML to render HTML content
                        ul.appendChild(li);
                    });

                    // Append the list to the summary element
                    summaryElement.appendChild(ul);
                }
            }

            // Initial Questions Group
            const nextButtonInitial = document.createElement('button');
            nextButtonInitial.innerText = 'Next';
            nextButtonInitial.type = 'button';
            nextButtonInitial.addEventListener('click', () => {
                if (checkExclusion()) {
                    alert('Patient is excluded from the UTI pathway.');
                } else {
                    toggleQuestionGroup('group_initial_questions', 'group_pyelonephritis_symptoms');
                }
            });
            document.getElementById('group_initial_questions').appendChild(nextButtonInitial);

            // Pyelonephritis Symptoms Group
            const nextButtonPyelo = document.createElement('button');
            nextButtonPyelo.innerText = 'Next';
            nextButtonPyelo.type = 'button';
            nextButtonPyelo.addEventListener('click', () => {
                const pyeloCheckboxes = document.querySelectorAll('#group_pyelonephritis_symptoms input[type="checkbox"]');
                if (checkAnyChecked(pyeloCheckboxes)) {
                    updateSummary('Urgent same day referral required:\n - General practice\n - Relevant out of hours service');
                    displaySummary();
                    toggleQuestionGroup('group_pyelonephritis_symptoms', 'group_applicable_for_all');
                } else {
                    Array.from(pyeloCheckboxes).forEach(cb => {
                        if (cb.checked) {
                            updateSummary(cb.nextElementSibling.textContent.trim());
                        }
                    });
                    toggleQuestionGroup('group_pyelonephritis_symptoms', 'group_additional_checks');
                }
            });
            document.getElementById('group_pyelonephritis_symptoms').appendChild(nextButtonPyelo);

            // Additional Checks Group
            const nextButtonAdditional = document.createElement('button');
            nextButtonAdditional.innerText = 'Next';
            nextButtonAdditional.type = 'button';
            nextButtonAdditional.addEventListener('click', () => {
                const additionalCheckboxes = document.querySelectorAll('#group_additional_checks input[type="checkbox"]');
                if (checkAnyChecked(additionalCheckboxes)) {
                    updateSummary('Onward referral:\n - General practice\n - Sexual health clinics\n - Other provider as appropriate');
                    displaySummary();
                    toggleQuestionGroup('group_additional_checks', 'group_applicable_for_all');
                } else {
                    Array.from(additionalCheckboxes).forEach(cb => {
                        if (cb.checked) {
                            updateSummary(cb.nextElementSibling.textContent.trim());
                        }
                    });
                    toggleQuestionGroup('group_additional_checks', 'group_key_diagnostic_signs');
                }
            });
            document.getElementById('group_additional_checks').appendChild(nextButtonAdditional);

            // Key Diagnostic Signs/Symptoms Group
            const nextButtonKeyDiagnostic = document.createElement('button');
            nextButtonKeyDiagnostic.innerText = 'Next';
            nextButtonKeyDiagnostic.type = 'button';
            nextButtonKeyDiagnostic.addEventListener('click', () => {
                const keyDiagnosticCheckboxes = document.querySelectorAll('#group_key_diagnostic_signs input[type="checkbox"]');
                const countChecked = Array.from(keyDiagnosticCheckboxes).filter(cb => cb.checked).length;
                if (countChecked >= 2) {
                    updateSummary('Shared decision making approach using TARGET UTI resources');
                    toggleQuestionGroup('group_key_diagnostic_signs', 'group_shared_decision_making');
                } else if (countChecked === 1) {
                    updateSummary('UTI equally likely to other diagnosis.');
                    displaySummary();
                    toggleQuestionGroup('group_key_diagnostic_signs', 'group_applicable_for_all');
                } else {
                    updateSummary('UTI less likely - Self-care and pain relief.');
                    displaySummary()
                    toggleQuestionGroup('group_key_diagnostic_signs', 'group_other_urinary_symptoms');
                }
            });
            document.getElementById('group_key_diagnostic_signs').appendChild(nextButtonKeyDiagnostic);

            // Other Urinary Symptoms Group
            const nextButtonOtherUrinary = document.createElement('button');
            nextButtonOtherUrinary.innerText = 'Next';
            nextButtonOtherUrinary.type = 'button';
            nextButtonOtherUrinary.addEventListener('click', () => {
                const otherUrinaryCheckboxes = document.querySelectorAll('#group_other_urinary_symptoms input[type="checkbox"]');
                if (checkAnyChecked(otherUrinaryCheckboxes)) {
                    updateSummary('UTI equally likely to other diagnosis.');
                    displaySummary();
                    toggleQuestionGroup('group_other_urinary_symptoms', 'group_applicable_for_all');
                } else {
                    updateSummary('UTI less likely - Self-care and pain relief.');
                    displaySummary()
                    toggleQuestionGroup('group_other_urinary_symptoms', 'group_applicable_for_all');
                }
                toggleQuestionGroup('group_other_urinary_symptoms', 'group_shared_decision_making');
            });
            document.getElementById('group_other_urinary_symptoms').appendChild(nextButtonOtherUrinary);

            // Shared Decision Making Group
            const nextButtonShared = document.createElement('button');
            nextButtonShared.innerText = 'Next';
            nextButtonShared.type = 'button';
            nextButtonShared.addEventListener('click', () => {
                const selectedOption = document.querySelector('input[name="decision_making"]:checked');
                if (selectedOption.value === 'mild') {
                    updateSummary('Ask patient to return to Pharmacy if no improvement in 48 hours for pharmacist reassessment');
                } else if (selectedOption.value === 'moderate_severe') {
                    updateSummary('Offer nitrofurantoin for 3 days (subject to inclusion/exclusion criteria in PGD) plus self-care');
                }
                displaySummary(); // Display the summary before showing the final group
                toggleQuestionGroup('group_shared_decision_making', 'group_applicable_for_all');
            });
            document.getElementById('group_shared_decision_making').appendChild(nextButtonShared);

            // Function to restart the form
            function restartForm() {
                // Reset all checkboxes and radio buttons to their initial state
                const form = document.getElementById("utiForm");
                form.reset();

                // Hide all question groups except the initial questions
                const questionGroups = document.querySelectorAll(".question-group");
                questionGroups.forEach(group => {
                    group.classList.add("hidden");
                });
                document.getElementById("group_initial_questions").classList.remove("hidden");

                // Clear the summary
                document.getElementById("summary").textContent = "";
                summaryInfo = [];
            }

            // Add an event listener to the "Restart" button
            const restartButton = document.getElementById("restartButton");
            restartButton.addEventListener("click", restartForm);

            // Form Submission
            document.getElementById('utiForm').addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(this);
                const data = {};
                formData.forEach((value, key) => {
                    data[key] = value === 'on';
                });

                fetch('http://localhost:8000/evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('result').innerText = 'Result: ' + data.result;
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            });
        });
    </script>

</body>
</html>
